name: Run tests

on:
  workflow_call:
    inputs:
      build_id:
        required: true
        type: string

jobs:
  prepare-boot-jobs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        machine:
          - iq-8275-evk
          - iq-9075-evk
          - qcm6490-idp
          #- qcs615-adp-air
          - rb3gen2-core-kit
          #- qcs8300-ride-sx
          - qcs9100-ride-sx
          - rb1-core-kit
          #- qcom-armv8a
          #- qcom-armv7a
        distro:
          - name: poky-altcfg
          - name: qcom-distro
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run lava-test-plans
        uses: ./.github/actions/lava-test-plans
        with:
          machine: ${{ matrix.machine }}
          distro_name: ${{ matrix.distro.name }}
          build_id: ${{ inputs.build_id }}
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          prefix: boottest

  prepare-boot-job-list:
    needs: prepare-boot-jobs
    runs-on: ubuntu-latest
    outputs:
      jobmatrix: ${{ steps.listjobs.outputs.jobmatrix }}
    steps:
      - name: 'Download job templates'
        uses: actions/download-artifact@v4
        with:
          pattern: boottest-*
      - uses: actions/setup-python@v4
        name: "Setup python"
        with:
          python-version: '3.x'
      - uses: jannekem/run-python-script-action@v1
        name: "List jobs"
        id: listjobs
        with:
          fail-on-error: false
          script: |
            import os

            target = []
            for dirpath, dirnames, filenames in os.walk("."):
                for filename in filenames:
                    if filename.endswith(('.yaml', '.yml')):
                        full_path = os.path.join(dirpath, filename)
                        result_file = full_path.replace("/", "-")[2:]
                        name = full_path.split("-", 1)[1].split("/")[0]
                        target.append({"path": full_path, "result_file": result_file, "name": name})
            set_output("jobmatrix", str({"target": target}))
            print({"target": target})


#      - name: "List jobs"
#        id: listjobs
#        run: |
#          JOBFILES=$(find . -name *.yaml)
#          JOBFILES=$(echo "$JOBFILES" | sed -e "s/^/\"/" | sed -e "s/$/\",/" | tr -d "\n" | sed -e "s/.$//")
#          JOBFILES="[${JOBFILES}]"
#          J=$(jq -cn --argjson jobfiles "$JOBFILES" '{target: $jobfiles}')
#          echo "jobmatrix=$J" >> $GITHUB_OUTPUT
#          echo "Preparing testjob files"

  submit-boot-job:
    needs: prepare-boot-job-list
    runs-on: ubuntu-latest
    continue-on-error: true
    name: Boot ${{ matrix.target.name }}
    strategy:
      matrix: ${{ fromJson(needs.prepare-boot-job-list.outputs.jobmatrix) }}
    steps:
      - name: 'Download job templates'
        uses: actions/download-artifact@v4
        with:
          pattern: boottest-*

#      - name: 'Prepare output file name'
#        run: |
#          OUTPUT_NAME=$(echo "${{ matrix.target }}" | sed "s|\/|-|g")
#          echo "RESULT_NAME=${OUTPUT_NAME#??}" >> $GITHUB_ENV

      - name: Submit ${{ matrix.target.name }}
        timeout-minutes: 20
        id: submit
        uses: foundriesio/lava-action@v9
        with:
          lava_token: ${{ secrets.LAVA_TOKEN }}
          lava_url: 'lava.infra.foundries.io'
          job_definition: ${{ matrix.target.path }}
          wait_for_job: true
          fail_action_on_failure: true
          fail_action_on_incomplete: true
          save_result_as_artifact: true
          save_job_details: true
#          result_file_name: "${{ env.RESULT_NAME }}"
          result_file_name: "${{ matrix.target.result_file }}"
      - uses: cloudposse/github-action-matrix-outputs-write@v1
        id: out
        with:
          matrix-step-name: ${{ github.job }}
          matrix-key: ${{ matrix.target.name }}
          outputs: |-
            result: ${{ steps.submit.outcome }}

  boot-job-result:
    runs-on: ubuntu-latest
    needs: [submit-boot-job]
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@v1
        id: read
        with:
          matrix-step-name: "submit-boot-job"
      - id: print-boot-result
        name: "Print boot result"
        run: |
          echo '${{ steps.read.outputs.result }}' | yq
          yq --version
          jq --version
          dpkg -l | grep yq
          dpkg -l | grep jq
          VALUES=$(echo '${{ steps.read.outputs.result }}' | yq '.[] | values | .[]')
          BOOT_RESULT="success"
          for v in $VALUES
          do
            if [ "$v" != "success" ]; then
              BOOT_RESULT="failure"
            fi
          done
          echo "boot_result=$BOOT_RESULT" >> "$GITHUB_OUTPUTS"
    outputs:
      result: "${{ steps.read.outputs.boot_result }}"

  prepare-premerge-jobs:
    needs: boot-job-result
    # run only if boot jobs are successful
    if: ${{ needs.boot-job-result.result == 'success' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        machine:
          - iq-8275-evk
          - iq-9075-evk
          - qcm6490-idp
          - qcs615-adp-air
          - rb3gen2-core-kit
          - qcs8300-ride-sx
          - qcs9100-ride-sx
          - rb1-core-kit
          #- qcom-armv8a
          #- qcom-armv7a
        distro:
          - name: poky-altcfg
          - name: qcom-distro
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run lava-test-plans
        uses: ./.github/actions/lava-test-plans
        with:
          machine: ${{ matrix.machine }}
          distro_name: ${{ matrix.distro.name }}
          build_id: ${{ inputs.build_id }}
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          prefix: pre-merge
          testplan: pre-merge

  prepare-premerge-job-list:
    needs: prepare-premerge-jobs
    runs-on: ubuntu-latest
    outputs:
      jobmatrix: ${{ steps.listjobs.outputs.jobmatrix }}
    steps:
      - name: 'Download job templates'
        uses: actions/download-artifact@v4
        with:
          pattern: pre-merge-*

      - name: "List jobs"
        id: listjobs
        run: |
          JOBFILES=$(find . -name *.yaml)
          JOBFILES=$(echo "$JOBFILES" | sed -e "s/^/\"/" | sed -e "s/$/\",/" | tr -d "\n" | sed -e "s/.$//")
          JOBFILES="[${JOBFILES}]"
          J=$(jq -cn --argjson jobfiles "$JOBFILES" '{target: $jobfiles}')
          echo "jobmatrix=$J" >> $GITHUB_OUTPUT
          echo "Preparing testjob files"

  submit-premerge-job:
    needs: prepare-premerge-job-list
    runs-on: ubuntu-latest
    continue-on-error: true
    name: Pre-merge ${{ matrix.target }}
    strategy:
      matrix: ${{ fromJson(needs.prepare-premerge-job-list.outputs.jobmatrix) }}
    steps:
      - name: 'Download job templates'
        uses: actions/download-artifact@v4
        with:
          pattern: pre-merge-*

      - name: 'Prepare output file name'
        run: |
          OUTPUT_NAME=$(echo "${{ matrix.target }}" | sed "s|\/|-|g")
          echo "RESULT_NAME=${OUTPUT_NAME#??}" >> $GITHUB_ENV

      - name: Submit ${{ matrix.target }}
        timeout-minutes: 20
        uses: foundriesio/lava-action@v9
        with:
          lava_token: ${{ secrets.LAVA_TOKEN }}
          lava_url: 'lava.infra.foundries.io'
          job_definition: ${{ matrix.target }}
          wait_for_job: true
          fail_action_on_failure: true
          fail_action_on_incomplete: true
          save_result_as_artifact: true
          save_job_details: true
          result_file_name: "${{ env.RESULT_NAME }}"

  publish-test-summary:
    name: "Publish Tests Summary"
    needs: submit-premerge-job
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: "List files"
        run: |
          echo $GITHUB_WORKSPACE
          ls -R $GITHUB_WORKSPACE

      - name: Publish Test Job Details
        run: |
          for json_file in $(find ${{ github.workspace }} -name "test-job-*.json")
          do
              DEVICE_TYPE=$(cat "$json_file" | jq -r ".requested_device_type")
              URL=$(cat "$json_file" | jq -r ".url")
              JOB_ID=$(cat "$json_file" | jq -r ".id")
              JOB_TITLE=$(cat "$json_file"| jq -r ".description")
              echo " * [Job $JOB_ID on $DEVICE_TYPE]($URL) - ${JOB_TITLE}"
              echo " * [Job $JOB_ID on $DEVICE_TYPE]($URL) - ${JOB_TITLE}" >> $GITHUB_STEP_SUMMARY
          done
