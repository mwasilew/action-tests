name: Run tests

on:
  workflow_call:
    inputs:
      url:
        required: true
        type: string
jobs:
  retrieve-job-list:
    outputs:
      jobmatrix: ${{ steps.listjobs.outputs.jobmatrix }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Print trigger
        run: |
          echo "Triggered by ${{ github.event_name }}"
          echo "Input: ${{ inputs.url }}"
      - name: "List jobs"
        id: listjobs
        run: |
          JOBFILES=$(find lava/ -name *.yaml)
          JOBFILES=$(echo "$JOBFILES" | sed -e "s/^/\"/" | sed -e "s/$/\",/" | tr -d "\n" | sed -e "s/.$//")
          JOBFILES="[${JOBFILES}]"
          J=$(jq -cn --argjson jobfiles "$JOBFILES" '{target: $jobfiles}')
          echo "jobmatrix=$J" >> $GITHUB_OUTPUT
          echo "Preparing testjob files"
      - name: 'Upload test jobs'
        uses: actions/download-artifact@v4
        timeout-minutes: 20
        with:
          name: testjobs
          path: lava/
    runs-on: ubuntu-latest
  submit-job:
    needs: retrieve-job-list
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.retrieve-job-list.outputs.jobmatrix) }}
    steps:
      - name: 'Download Artifacts ${{ matrix.target }}'
        uses: actions/download-artifact@v4
        timeout-minutes: 20
        with:
          name: testjobs
          path: lava/

      - name: Submit ${{ matrix.target }}
        run: |
          echo "Submitting ${{ matrix.target }}"

